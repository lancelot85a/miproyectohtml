<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador VAK Mejorado con TextRazor</title>
    <style>
        /* (Tu CSS existente permanece igual) */
        /* ... (CSS omitido para brevedad) ... */
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Analizador VAK Mejorado con TextRazor</h1>
        </header>
        <nav>
            <button id="toggle-theme" aria-label="Alternar modo oscuro">üåô Modo Oscuro</button>
            <button id="show-info" aria-label="Mostrar informaci√≥n">‚ÑπÔ∏è Informaci√≥n</button>
            <button id="show-stats" aria-label="Mostrar estad√≠sticas">üìä Estad√≠sticas</button>
        </nav>
        <main>
            <section class="text-input-section">
                <h2>Ingrese su texto para analizar</h2>
                <div class="textarea-container">
                    <label for="text-input" class="sr-only">Ingresa tu texto aqu√≠</label>
                    <textarea id="text-input" placeholder="Escriba o pegue su texto aqu√≠..." aria-label="√Årea de texto para ingresar el discurso"></textarea>
                </div>
                <button id="analyze-btn" class="analyze-button" aria-label="Analizar texto">Analizar Texto</button>
            </section>
            <section class="analysis-section">
                <h2>Resultado del An√°lisis</h2>
                <div id="analysis-result" class="analysis-result">
                    El texto analizado aparecer√° aqu√≠...
                </div>
                <div class="stats-section">
                    <div class="stat-item">
                        <h3>Visual</h3>
                        <p id="visual-count">0</p>
                    </div>
                    <div class="stat-item">
                        <h3>Auditivo</h3>
                        <p id="auditory-count">0</p>
                    </div>
                    <div class="stat-item">
                        <h3>Kinest√©sico</h3>
                        <p id="kinesthetic-count">0</p>
                    </div>
                    <div class="stat-item">
                        <h3>Auditivo Digital</h3>
                        <p id="auditory-digital-count">0</p>
                    </div>
                </div>
                <div class="sequence-analysis">
                    <h3>An√°lisis de Secuencia</h3>
                    <p id="sequence-result">La secuencia predominante aparecer√° aqu√≠...</p>
                </div>
                <div class="vak-words-section">
                    <!-- Las listas de palabras VAK aparecer√°n aqu√≠ -->
                </div>
                <div class="entity-analysis">
                    <h3>Entidades Nombradas</h3>
                    <p id="entity-result">Las entidades identificadas aparecer√°n aqu√≠...</p>
                </div>
                <div class="chart-container">
                    <canvas id="vakChart" width="400" height="200"></canvas>
                </div>
            </section>
            <button class="btn-export" id="export-results" aria-label="Exportar resultados">Exportar Resultados</button>
        </main>
    </div>

    <!-- Modal de Estad√≠sticas -->
    <div id="stats-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="stats-title" aria-modal="true">
        <div class="modal-content">
            <span class="close" aria-label="Cerrar">&times;</span>
            <div class="stats-content" id="stats-content">
                <h2 id="stats-title">üìä Estad√≠sticas de Usuario</h2>
                <p>Textos Analizados: <span id="texts-analyzed">0</span></p>
                <p>Palabras Visuales: <span id="visual-count-modal">0</span></p>
                <p>Palabras Auditivas: <span id="auditory-count-modal">0</span></p>
                <p>Palabras Kinest√©sicas: <span id="kinesthetic-count-modal">0</span></p>
                <p>Palabras Auditivo Digital: <span id="auditory-digital-count-modal">0</span></p>
            </div>
        </div>
    </div>

    <!-- Modal Informativo -->
    <div id="info-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="info-title" aria-modal="true">
        <div class="modal-content">
            <span class="close" aria-label="Cerrar">&times;</span>
            <h2 id="info-title">‚ÑπÔ∏è Informaci√≥n sobre el Analizador VAK Mejorado</h2>
            <p>El Analizador VAK es una herramienta dise√±ada para identificar elementos sensoriales en textos, bas√°ndose
                en el modelo de Programaci√≥n Neuroling√º√≠stica (PNL) que clasifica la percepci√≥n en cuatro sistemas
                principales: Visual, Auditivo, Kinest√©sico y Auditivo Digital.</p>
            <h3>C√≥mo funciona:</h3>
            <ul>
                <li><strong>Visual:</strong> Identifica palabras relacionadas con la vista y las im√°genes mentales.</li>
                <li><strong>Auditivo:</strong> Detecta t√©rminos asociados con el sonido y la escucha.</li>
                <li><strong>Kinest√©sico:</strong> Reconoce palabras vinculadas a sensaciones y emociones.</li>
                <li><strong>Auditivo Digital:</strong> Detecta t√©rminos relacionados con el pensamiento l√≥gico y anal√≠tico.</li>
            </ul>
            <p>Adem√°s, utilizando la API de TextRazor, el analizador identifica entidades nombradas y relaciones
                sem√°nticas para enriquecer el an√°lisis y proporcionar una comprensi√≥n m√°s profunda del texto.</p>
        </div>
    </div>

    <!-- Incluimos la biblioteca Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Funci√≥n para escapar caracteres especiales en expresiones regulares
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Listas de palabras VAK usando ra√≠ces y patrones
        const visualPatterns = [
            /\b(visual\w*)\b/gi,
            /\b(clar\w*)\b/gi,
            /\b(vid\w*)\b/gi,
            /\b(mir\w*)\b/gi,
            /\b(observ\w*)\b/gi,
            /\b(enfoc\w*)\b/gi,
            /\b(perspect\w*)\b/gi,
            /\b(imagen\w*)\b/gi,
            /\b(color\w*)\b/gi,
            /\b(aparienc\w*)\b/gi,
            /\b(sombr\w*)\b/gi,
            /\b(visualizar\w*)\b/gi,
            /\b(ilumin\w*)\b/gi,
            /\b(visi√≥n)\b/gi,
            /\b(ver)\b/gi,
            /\b(visto)\b/gi,
            /\b(veo)\b/gi
        ];

        const auditoryPatterns = [
            /\b(audit\w*)\b/gi,
            /\b(sonid\w*)\b/gi,
            /\b(escuch\w*)\b/gi,
            /\b(o[i|√≠|y]r\w*)\b/gi,
            /\b(habl\w*)\b/gi,
            /\b(sonar\w*)\b/gi,
            /\b(reson\w*)\b/gi,
            /\b(ruido\w*)\b/gi,
            /\b(silenci\w*)\b/gi,
            /\b(susurr\w*)\b/gi,
            /\b(melod\w*)\b/gi,
            /\b(cantar\w*)\b/gi,
            /\b(grit\w*)\b/gi,
            /\b(decir\w*)\b/gi,
            /\b(escucho)\b/gi
        ];

        const kinestheticPatterns = [
            /\b(sent\w*)\b/gi,
            /\b(tocar\w*)\b/gi,
            /\b(sensac\w*)\b/gi,
            /\b(mov\w*)\b/gi,
            /\b(camin\w*)\b/gi,
            /\b(correr\w*)\b/gi,
            /\b(calor\w*)\b/gi,
            /\b(fr[i|√≠]o\w*)\b/gi,
            /\b(presi[√≥|o]n\w*)\b/gi,
            /\b(fuerz\w*)\b/gi,
            /\b(sostener\w*)\b/gi,
            /\b(tens[√≥|o]n\w*)\b/gi,
            /\b(agarra\w*)\b/gi,
            /\b(golpe\w*)\b/gi,
            /\b(palpit\w*)\b/gi,
            /\b(siento)\b/gi
        ];

        const auditoryDigitalPatterns = [
            /\b(pens\w*)\b/gi,
            /\b(concept\w*)\b/gi,
            /\b(entend\w*)\b/gi,
            /\b(comprend\w*)\b/gi,
            /\b(conoc\w*)\b/gi,
            /\b(l√≥gic\w*)\b/gi,
            /\b(analiz\w*)\b/gi,
            /\b(proces\w*)\b/gi,
            /\b(sistem\w*)\b/gi,
            /\b(calcul\w*)\b/gi,
            /\b(estudi\w*)\b/gi,
            /\b(cuestion\w*)\b/gi,
            /\b(inform\w*)\b/gi,
            /\b(decid\w*)\b/gi,
            /\b(plane\w*)\b/gi,
            /\b(razon\w*)\b/gi,
            /\b(ideas?)\b/gi,
            /\b(pensamiento)\b/gi
        ];

        // Variables de Usuario
        let userStats = {
            textsAnalyzed: 0,
            visualCount: 0,
            auditoryCount: 0,
            kinestheticCount: 0,
            auditoryDigitalCount: 0
        };

        // Inicializaci√≥n del Gr√°fico
        let vakChart;

        async function analyzeText() {
            const textInput = document.getElementById('text-input').value;
            if (!textInput.trim()) {
                alert("Por favor, ingresa un texto para analizar.");
                return;
            }

            // Analizar el texto localmente para detectar palabras VAK
            const analysis = highlightText(textInput);
            document.getElementById('analysis-result').innerHTML = analysis.highlighted;

            // Actualizar estad√≠sticas
            userStats.textsAnalyzed++;
            userStats.visualCount += analysis.visualCount;
            userStats.auditoryCount += analysis.auditoryCount;
            userStats.kinestheticCount += analysis.kinestheticCount;
            userStats.auditoryDigitalCount += analysis.auditoryDigitalCount;
            updateStats();

            // Mostrar secuencia VAK
            const sequence = getSequence(textInput);
            document.getElementById('sequence-result').textContent = `Secuencia VAK: ${sequence.join(' ‚ûî ')}`;

            // Mostrar listas de palabras VAK
            displayVAKWords(analysis);

            // Actualizar gr√°fico
            updateChart(analysis);

            // An√°lisis adicional con TextRazor
            await analyzeWithTextRazor(textInput);
        }

        function highlightText(text) {
            let visualCount = 0;
            let auditoryCount = 0;
            let kinestheticCount = 0;
            let auditoryDigitalCount = 0;

            // Tokenizar el texto para evitar reemplazos dentro de etiquetas HTML
            const tokens = text.split(/(\s+|\n|<br>)/);

            // Orden de categor√≠as para evitar superposiciones
            const categories = [
                { patterns: auditoryDigitalPatterns, class: 'auditory-digital-word', type: 'Auditivo Digital' },
                { patterns: visualPatterns, class: 'visual-word', type: 'Visual' },
                { patterns: auditoryPatterns, class: 'auditory-word', type: 'Auditivo' },
                { patterns: kinestheticPatterns, class: 'kinesthetic-word', type: 'Kinest√©sico' }
            ];

            const highlightedTokens = tokens.map(token => {
                if (/^\s+$/.test(token) || token === '\n' || token === '<br>') {
                    return token;
                }

                let matched = false;

                for (const category of categories) {
                    for (const pattern of category.patterns) {
                        if (pattern.test(token)) {
                            matched = true;

                            // Incrementar el contador correspondiente
                            if (category.type === 'Visual') visualCount++;
                            if (category.type === 'Auditivo') auditoryCount++;
                            if (category.type === 'Kinest√©sico') kinestheticCount++;
                            if (category.type === 'Auditivo Digital') auditoryDigitalCount++;

                            return `<span class="highlight ${category.class}" data-tooltip="${category.type}: ${token}">${token}</span>`;
                        }
                    }
                    if (matched) break;
                }

                return token;
            });

            const highlighted = highlightedTokens.join('');

            return { highlighted, visualCount, auditoryCount, kinestheticCount, auditoryDigitalCount };
        }

        function updateStats() {
            document.getElementById('texts-analyzed').textContent = userStats.textsAnalyzed;
            document.getElementById('visual-count').textContent = userStats.visualCount;
            document.getElementById('auditory-count').textContent = userStats.auditoryCount;
            document.getElementById('kinesthetic-count').textContent = userStats.kinestheticCount;
            document.getElementById('auditory-digital-count').textContent = userStats.auditoryDigitalCount;

            // Actualizar tambi√©n en el modal
            document.getElementById('visual-count-modal').textContent = userStats.visualCount;
            document.getElementById('auditory-count-modal').textContent = userStats.auditoryCount;
            document.getElementById('kinesthetic-count-modal').textContent = userStats.kinestheticCount;
            document.getElementById('auditory-digital-count-modal').textContent = userStats.auditoryDigitalCount;
        }

        function exportResults() {
            const analyzedText = document.getElementById('analysis-result').innerText;
            const sequence = document.getElementById('sequence-result').textContent;
            const entities = document.getElementById('entity-result').innerText;
            const vakWords = document.querySelector('.vak-words-section').innerText;
            const content = `Texto Analizado:\n${analyzedText}\n\n${sequence}\n\nEntidades:\n${entities}\n\nPalabras VAK:\n${vakWords}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resultado_vak.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const toggleButton = document.getElementById('toggle-theme');
            if (document.body.classList.contains('dark-mode')) {
                toggleButton.innerText = '‚òÄÔ∏è Modo Claro';
                toggleButton.setAttribute('aria-label', 'Alternar modo claro');
            } else {
                toggleButton.innerText = 'üåô Modo Oscuro';
                toggleButton.setAttribute('aria-label', 'Alternar modo oscuro');
            }
        }

        // Funci√≥n para mostrar estad√≠sticas
        function showStats() {
            showModal('stats-modal');
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
        }

        // Cerrar modales al hacer clic en el bot√≥n de cerrar
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function () {
                const modal = this.closest('.modal');
                closeModal(modal.id);
            });
        });

        // Cerrar modales si el usuario hace clic fuera de ellos
        window.addEventListener('click', function (event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Detectar preferencia de color del sistema y ajustar autom√°ticamente
        function detectColorScheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggle-theme').innerText = '‚òÄÔ∏è Modo Claro';
                document.getElementById('toggle-theme').setAttribute('aria-label', 'Alternar modo claro');
            }
        }

        window.addEventListener('load', () => {
            detectColorScheme();
        });

        // Funci√≥n para mostrar listas de palabras VAK detectadas
        function displayVAKWords(analysis) {
            const vakWordsSection = document.querySelector('.vak-words-section');
            vakWordsSection.innerHTML = ''; // Limpiar contenido previo

            const categories = [
                { type: 'Visual', words: analysis.visualWords },
                { type: 'Auditivo', words: analysis.auditoryWords },
                { type: 'Kinest√©sico', words: analysis.kinestheticWords },
                { type: 'Auditivo Digital', words: analysis.auditoryDigitalWords }
            ];

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.classList.add('vak-category');

                const title = document.createElement('h3');
                title.textContent = `Palabras ${category.type}`;
                categoryDiv.appendChild(title);

                const wordList = document.createElement('p');
                wordList.textContent = category.words.join(', ') || 'Ninguna';
                categoryDiv.appendChild(wordList);

                vakWordsSection.appendChild(categoryDiv);
            });
        }

        function getSequence(text) {
            const words = text.toLowerCase().split(/\s+/);
            const sequence = [];
            const added = new Set();

            const categories = [
                { patterns: auditoryDigitalPatterns, symbol: 'AD' },
                { patterns: visualPatterns, symbol: 'V' },
                { patterns: auditoryPatterns, symbol: 'A' },
                { patterns: kinestheticPatterns, symbol: 'K' }
            ];

            words.forEach(word => {
                // Eliminar puntuaci√≥n
                const cleanWord = word.replace(/[.,!?;:()]+$/g, '').toLowerCase();
                for (const category of categories) {
                    for (const pattern of category.patterns) {
                        if (pattern.test(cleanWord) && !added.has(category.symbol)) {
                            sequence.push(category.symbol);
                            added.add(category.symbol);
                            break;
                        }
                    }
                }
            });

            return sequence;
        }

        function updateChart(analysis) {
            const ctx = document.getElementById('vakChart').getContext('2d');
            const data = {
                labels: ['Visual', 'Auditivo', 'Kinest√©sico', 'Auditivo Digital'],
                datasets: [{
                    label: 'Palabras VAK',
                    data: [analysis.visualCount, analysis.auditoryCount, analysis.kinestheticCount, analysis.auditoryDigitalCount],
                    backgroundColor: [
                        'rgba(0, 64, 255, 0.6)',
                        'rgba(161, 3, 3, 0.6)',
                        'rgba(1, 117, 100, 0.6)',
                        'rgba(255, 140, 0, 0.6)'
                    ],
                    borderColor: [
                        'rgba(0, 64, 255, 1)',
                        'rgba(161, 3, 3, 1)',
                        'rgba(1, 117, 100, 1)',
                        'rgba(255, 140, 0, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            if (window.vakChart) {
                window.vakChart.data.datasets[0].data = data.datasets[0].data;
                window.vakChart.update();
            } else {
                window.vakChart = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        // Integraci√≥n con la API de TextRazor
        async function analyzeWithTextRazor(text) {
            try {
                // Reemplaza con la URL correcta de tu funci√≥n serverless
                const response = await fetch('/.netlify/functions/textrazor?text=' + encodeURIComponent(text), {
                    method: 'GET'
                });

                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }

                const data = await response.json();

                // Procesar y mostrar los resultados adicionales
                processTextRazorData(data);

            } catch (error) {
                console.error('Error al comunicarse con la funci√≥n serverless:', error);
                alert('Ocurri√≥ un error al analizar el texto.');
            }
        }

        function processTextRazorData(data) {
            if (!data.response) {
                alert('No se obtuvieron resultados de TextRazor.');
                return;
            }

            // Mostrar entidades nombradas sin resaltar en el texto
            const entities = data.response.entities || [];
            const uniqueEntities = new Set();
            entities.forEach(entity => {
                uniqueEntities.add(entity.matchedText);
            });

            const entityResult = Array.from(uniqueEntities).join(', ');
            document.getElementById('entity-result').textContent = `Entidades: ${entityResult}`;

            // Opcional: Mostrar temas principales
            const topics = data.response.topics || [];
            const topTopics = topics.slice(0, 5).map(topic => topic.label).join(', ');
            if (topTopics) {
                const topicElement = document.createElement('p');
                topicElement.textContent = `Temas Principales: ${topTopics}`;
                document.querySelector('.entity-analysis').appendChild(topicElement);
            }
        }

        // Event Listeners
        document.getElementById('analyze-btn').addEventListener('click', analyzeText);
        document.getElementById('export-results').addEventListener('click', exportResults);
        document.getElementById('toggle-theme').addEventListener('click', toggleDarkMode);
        document.getElementById('show-info').addEventListener('click', function () {
            showModal('info-modal');
        });
        document.getElementById('show-stats').addEventListener('click', showStats);
    </script>
</body>

</html>
